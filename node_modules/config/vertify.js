/**
 * Created by Sven on 7/5/2016.
 */
/* PATH: host_url:8080/vertify
 *
 * INPUT:
 * 'phone_number'
 *
 * OUTPUT:
 *  JSON Object that contains
 *  'code' : respond code
 *  'msg' : respond message
 *  'object_id' : upon successful send code and register phone in database(only for debug purposes)
 *
 *
 *  1 -> Successfully register phone in database
 * -1 -> Incorrect Object_id
 * -6 -> Incorrect phone_number format
 * -7 -> Required field not set
 */

var mongoose = require('mongoose');
var models = require('config/models');

exports.vertify = function(code,objectid,callback) {
    if (!code) {
        callback({
            'code': "-7",
            'msg': "Required field not set"
        });
        return;
    }

    if (code.trim().length == 0 || code.length != 4 || !/^\d+$/.test(code)) {
        callback({
            'code': "-6",
            'msg': "Incorrect validation code format"
        });
        return;
    }

    models.User.find({_id: objectid},function(err,users){
        if(users.length == 0){
            callback({
                'code': "-1",
                'msg': "Incorrect object id"
            });
        }else{
            var dbcode = users[0].code;
            if(dbcode == code){
                models.User.findByIdAndUpdate(objectid, {$set: {vertify_flag: true}},function(err, result){
                    if(err){
                        console.log(err);
                    }
                    console.log("RESULT: " + result);
                });
                callback({
                    'code': "1",
                    'msg': objectid + " has been validated"
                });
            }else{
                callback({
                    'code': "-1",
                    'msg': "Incorrect validation code"
                });
            }
        }
    })
}