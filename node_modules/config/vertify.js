/**
 * Created by Sven on 7/5/2016.
 */
/* PATH: host_url:8080/vertify
 *
 * INPUT:
 * 'code'
 * 'phone_number'
 *
 * OUTPUT:
 *  JSON Object that contains
 *  'code' : respond code
 *  'msg' : respond message
 *  'object_id' : upon successful send code and register phone in database(only for debug purposes)
 *
 *
 *  1 -> Successfully register phone in database
 * -1 -> Incorrect validation code
 * -2 -> Incorrect phone_number
 * -6 -> Incorrect phone_number format
 * -7 -> Required field not set
 */

var mongoose = require('mongoose');
var models = require('config/models');

exports.vertify = function(code,phone_number,callback) {
    if (!code) {
        callback({
            'code': "-7",
            'msg': "Required field not set"
        });
        return;
    }
    console.log('vertify code is '+ code);
    console.log('trim code is '+ code.trim());
    console.log('length code is '+ code.trim().length);
    if (code.trim().length == 0 || code.trim().length != 4 || !/^\d+$/.test(code)) {
        callback({
            'code': "-6",
            'msg': "Incorrect validation code format"
        });
        return;
    }
    console.log("-> valid vertify code is recived");
    models.User.find({phone_number: phone_number},function(err,users){
        console.log('users.length '+ users.length);
        if(users.length == 0){
            callback({
                'code': "-2",
                'msg': "Incorrect phone_number"
            });
        }else{
            var dbcode = users[0].code;
            if(dbcode == code){
                models.User.findOneAndUpdate({phone_number: phone_number}, {$set: {vertify_flag: true}},function(err, result){
                    if(err){
                        console.log(err);
                    }
                    console.log("RESULT: " + result);
                });
                callback({
                    'code': "1",
                    'msg': phone_number + " has been validated"
                });
            }else{
                callback({
                    'code': "-1",
                    'msg': "Incorrect validation code"
                });
            }
        }
    })
}